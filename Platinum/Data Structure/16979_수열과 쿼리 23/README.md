
# [Platinum I] 수열과 쿼리 23 - 16979

[문제 링크](https://www.acmicpc.net/problem/16979)

### 문제 요약

<p> 길이 N의 수열과 Q개의 쿼리가 주어진다. 각 쿼리에 대한 답을 출력하자. </p>

### 제한

TL : 5sec, ML : 512 MB

1 ≤ N, Q ≤ 100,000

1 ≤ N_i ≤ 1,000,000,000

### 성능 요약

메모리: 5160 KB, 시간: 1464 ms

### 분류

자료 구조(data structures), 세그먼트 트리(segtree), 오프라인 쿼리(offline_queries), mo's(mo's algorithm), 좌표 압축(coordinate_compression)

### comment

수의 범위가 최대 10억까지 간다. 우선 좌표 압축을 통해 수의 등장 범위를 1 ~ 100,000까지 줄여주자.

이제 우리는 아래의 쿼리를 처리해야 한다.

* s e : s ≤ i < j ≤ e 이면서 N_i > N_j인 (i, j) 쌍의 개수를 출력한다. (1 ≤ s ≤ e ≤ N)

수의 범위가 좁혀졌음에 따라, 이를 그대로 인덱스 삼아 등장 횟수에 따른 카운팅 세그먼트 트리 문제로 바라볼 수 있다.

즉, 각 쿼리당 O(logN)의 복잡도로 개수를 세줄 수 있다.

또한 직접적인 업데이트 쿼리가 없으므로 sqrt단위 버킷의 mo's를 적용하면

대략 O(max(N, Q) * √NlogN) 정도로 문제를 해결할 수 있다.

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

크게 두가지로 나눠서 생각해보자.

* 어떤 수(x)가 현재 구간에 포함되려할 때
* 어떤 수(x)가 현재 구간에서 제외되려할 때

첫번째 경우를 보자.

x가 추가 된다면 현재 보는 구간(세그먼트 트리)상에 x보다 {작은 수 || 큰 수 : N_i > N_j에 따라 s, e에서의 차이가 존재} 의 개수를 더해 주어야 한다.

이후 세그먼트 트리에 x를 추가해준다.

두번째 경우를 보자.

x가 제외 된다면 우선 세그먼트 트리에서 x를 제거해야 한다.

이후 이로인해 현재 보는 구간(세그먼트 트리)상에 x보다 {작은 수 || 큰 수 : N_i > N_j에 따라 s, e에서의 차이가 존재} 의 개수를 빼 주어야 한다.

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

간단한 카운팅 문제라 세그는 기본적인 합세그로 구현하면 돼서 바로 짜고 냈더니 TLE를 얻어 맞았다.

분명 복잡도 상으론 충분해 보였는데.. 시간 제한도 무려 5초고.. 그러나 사실 엄청난 차이가 존재했다.

고인물분들의 조언을 통해 재귀 세그와 펜윅 트리 상에 굉장히 큰 상수 차이가 존재함을 알게 되었다.

쿼리 당 같은 O(logN)의 복잡도를 가져도 펜윅이 훨씬 상수 시간에 근접했던 것이다.

더군다나 sqrt까지 껴있으니 차이가 더 크게 느껴졌다.

그렇게 결국 펜윅 트리를 다음날 익히고 세그만 바꿔서 약 1.4초로 빠른 시간 내에 AC를 받을 수 있었다. (차이 겁나 크네..)

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

그러나 재귀 세그가 절대 딸리는 게 아닌게, 필요한 세그의 형태가 약간만 복잡해져도 펜윅으론 머리가 어질어질해진다.

대충 레이지, 구조체 세그, 머지 소트 트리 등의 형태에선 재귀 세그가 다방면에서 유용하다.

그동안 꽤 많은 세그 응용 문제들을 풀었지만 재귀, 비재귀 세그에서의 TLE 여부가 갈리는 건 이 문제가 처음이었다.

결론 : 상황에 따라 알맞게 써먹자. (펜윅 트리 코드는 아무리봐도 경이롭다. 천재들이 왜이렇게 많은지..)
